## –ì–ª—É–±–∂–µ –≤ –∫—Ä–æ–ª–∏—á—å—é –Ω–æ—Ä—É: `Future`, `Pin`, `Unpin` –∏ `Stream` üêá

–î–æ —Å–∏—Ö –ø–æ—Ä –º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `async/await` –∫–∞–∫ –º–∞–≥–∏—é. –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ —ç—Ç–∞ –º–∞–≥–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (–∏ –ø–æ—á–µ–º—É –∏–Ω–æ–≥–¥–∞ –æ–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç –∂–µ—Ä—Ç–≤–æ–ø—Ä–∏–Ω–æ—à–µ–Ω–∏–π –≤ –≤–∏–¥–µ `Pin`).

### `Future`: –°–µ—Ä–¥—Ü–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏

```rust
pub trait Future {
    type Output;
    fn poll(self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Self::Output>;
}
```

- **`poll`**: –≠—Ç–æ –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç —Ä–∞–Ω—Ç–∞–π–º. –û–Ω —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: "–ù—É —á—Ç–æ, –≥–æ—Ç–æ–≤–æ?".
- **`Pin<&mut Self>`**: –≠—Ç–æ "–±—É–ª–∞–≤–∫–∞". –û–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ—å—é—á–µ—Ä –Ω–µ —Å–¥–≤–∏–Ω–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏.

#### –ó–∞—á–µ–º –Ω–∞–º `Pin`?
–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è –≤ —Å—Ç–µ–π—Ç-–º–∞—à–∏–Ω—ã (state machines). –í–Ω—É—Ç—Ä–∏ —ç—Ç–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –º–æ–≥—É—Ç –±—ã—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–º–∏—Ö —Å–µ–±—è (self-referential). –ï—Å–ª–∏ –≤—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ —Ç–∞–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ –ø–∞–º—è—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `mem::swap`), —Å—Å—ã–ª–∫–∏ –Ω–∞—á–Ω—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ "—Å—Ç–∞—Ä–æ–µ" –º–µ—Å—Ç–æ, –≥–¥–µ —É–∂–µ –º—É—Å–æ—Ä.
`Pin` –≥–æ–≤–æ—Ä–∏—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—É: "–≠—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –ø—Ä–∏–∫–æ–ª–æ—á–µ–Ω –≥–≤–æ–∑–¥—è–º–∏ –∫ –∞–¥—Ä–µ—Å—É. –ï–≥–æ –Ω–µ–ª—å–∑—è –¥–≤–∏–≥–∞—Ç—å".

#### `Unpin`: –î–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –ª—é–¥–µ–π
–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ç–∏–ø–æ–≤ –≤ Rust (—á–∏—Å–ª–∞, —Å—Ç—Ä–æ–∫–∏, –≤–µ–∫—Ç–æ—Ä—ã) ‚Äî `Unpin`. –ò—Ö –º–æ–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ.
–ù–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ async-–±–ª–æ–∫–∞–º–∏ —Ñ—å—é—á–µ—Ä—ã ‚Äî `!Unpin`. –ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É –≤–∞–º –∏–Ω–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Box::pin` –∏–ª–∏ –º–∞–∫—Ä–æ—Å `pin!`.

### `Stream`: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ò—Ç–µ—Ä–∞—Ç–æ—Ä

–ï—Å–ª–∏ `Future` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å, —Ç–æ `Stream` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç *—Å–µ—Ä–∏—é* –∑–Ω–∞—á–µ–Ω–∏–π –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å.

```rust
trait Stream {
    type Item;
    fn poll_next(self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Option<Self::Item>>;
}
```

–≠—Ç–æ –∫–∞–∫ `Iterator`, —Ç–æ–ª—å–∫–æ —Å `context` –∏ `Poll`.
–ö —Å—á–∞—Å—Ç—å—é, –Ω–∞–º —Ä–µ–¥–∫–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —ç—Ç–æ –≤—Ä—É—á–Ω—É—é. –ï—Å—Ç—å `async-stream` –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª–µ–∑–Ω—ã–µ –∫—Ä–µ–π—Ç—ã.

### –ò—Ç–æ–≥

–í–∞–º –≤—Ä—è–¥ –ª–∏ –ø—Ä–∏–¥–µ—Ç—Å—è –ø–∏—Å–∞—Ç—å —Å–≤–æ–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `poll` –∏ `Pin`, –µ—Å–ª–∏ –≤—ã –Ω–µ –ø–∏—à–µ—Ç–µ —Å–≤–æ–π —Ä–∞–Ω—Ç–∞–π–º –∏–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞. –ù–æ –ø–æ–Ω–∏–º–∞—Ç—å —ç—Ç—É –æ—à–∏–±–∫—É –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞:
`error[E0277]: the trait bound MyFuture: Unpin is not satisfied`
‚Äî –±–µ—Å—Ü–µ–Ω–Ω–æ.

---

**–ê–Ω–µ–∫–¥–æ—Ç:**

> ‚Äî –î–æ–∫—Ç–æ—Ä, –º–Ω–µ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ —è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω –≤ –ø–∞–º—è—Ç–∏ –∏ –Ω–µ –º–æ–≥—É –¥–≤–∏–≥–∞—Ç—å—Å—è.  
> ‚Äî –£—Å–ø–æ–∫–æ–π—Ç–µ—Å—å, —É –≤–∞—Å –ø—Ä–æ—Å—Ç–æ `Pin<Box<Self>>`. –≠—Ç–æ –ª–µ—á–∏—Ç—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π `Unpin`.  
> ‚Äî –ù–æ —è async-–±–ª–æ–∫!  
> ‚Äî –ê, –Ω—É —Ç–æ–≥–¥–∞ —Å–º–∏—Ä–∏—Ç–µ—Å—å. –¢–µ–ø–µ—Ä—å —ç—Ç–æ –≤–∞—à–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞.
